# Паблишинг пакетов

Для паблишинга и управлением версиями пакетов используется [lerna](https://lerna.js.org/).

Lerna определяет, до какой версии нужно поднять тот или иной пакет на основе изменений в `git` и имен коммитов по спецификации [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/).

Пакеты являются публичными и паблишатся в [Github-реджистри](https://npm.pkg.github.com).

Скоуп пакетов — [@gpn-prototypes](https://github.com/orgs/ttteam-org/packages).

Примеры пакетов: `@ttteam-org/vega-hooks`, `@ttteam-org/vega-ui`, `@ttteam-org/vega-modal`

### Пакет с пакетами и отдельные пакеты

Внимание! В данной либе есть возможность устанавливать отдельные пакеты, например `@gpn-prototypes/vega-modal`.
И есть возможность устанавливать сразу всю либу целиком, в случае когда будут использоваться все или почти все компоненты отсюда. Для этого есть «пакет с пакетами» — `@gpn-prototypes/vega-ui`.

Наличие такого «пакета с пакетами» требует соблюдения четкой иерархии директорий. Пакет с пакетами должен содержать внутренние пакеты внутри себя. Иначе lerna не может его корректно версионировать:

![](http://s.csssr.ru/U02GZ926T/2020-05-15-1511-aenyraj433.jpg)

При сборке пакетов `rollup` создает папку `dist` на том же уровне, что и другие пакеты, что выглядит не очень красиво. Со временем постараемся решить эту проблему и спрятать внутренности пакета с пакетами.

## До публикации

Перед мержем в мастер и паблишем стабильной версии должно быть пройдено ревью и тестирование изменений.

PR с изменениями может попасть в мастер 2-мя способами:

1. напрямую в мастер (чаще всего)
1. в релизную ветку с последующим релизом

### Ревью и тестирование задач

После окончания разработки PR отдается на ревью. Получив 2 аппрува, нужно повесить на PR лейбл `RFT` и двинуть задачу в Jira в `Ready for test`. При передаче на тестирование в ветку задачи нельзя ничего пушить, не предупредив QA.

Тестирование должно проходить до мержа PR на стенде сторибука для нужной ветки. QA берет ссылку в PR.
Если находятся недочеты — QA убирает из PR лейбл `RFT` и реопает задачу в Jira.

Со временем это автоматизируем. Пока делать всё вручную.

## Публикация

При публикации происходит загрузка новых версий пакетов в Github-реджистри.

### Публикация через Github Actions

Запускается автоматически при пуше в мастер или в релизную ветку.

[Конфигурация](../.github/workflows/publish.yml).

Происходят следующие действия:

1. `yarn` устанавливает зависимости
1. `rollup` собирает пакеты
1. `lerna` поднимает версии измененных пакетов (подробности ниже)
1. `lerna` создает теги релизов в GitHub
1. `lerna` пушит обновленные пакеты в Github-реджистри и пушит коммит с поднятием версии в `master`

### Публикация вручную

Делаем то же, что и CI, но вручную:

1. генерируем токен в своем гитхабе: https://github.com/settings/tokens — Generate new token
2. логинимся в реджистри гитхаба через npm:

```bash
$ npm login --registry=https://npm.pkg.github.com`
> Username: USERNAME
> Password: TOKEN
> Email: PUBLIC-EMAIL-ADDRESS
```

3. переходим в ветку `master` локально
4. поднимаем версии пакетов с помощью `lerna`
   `yarn lerna version --conventional-commits --allow-branch=master --no-commit-hooks --no-push --yes --create-release github`

5. запускаем публикацию пакетов с помощью `lerna`
   `yarn lerna publish from-git --yes --registry https://npm.pkg.github.com/gpn-prototypes`

6. пушим коммит и теги в мастер
   `git push origin master --follow-tags`

## После публикации

Пакеты становятся доступны публично, привязываются к организации [gpn-prototypes](https://github.com/orgs/gpn-prototypes/packages) и к репозиторию [gpn-protptype/vega-ui](https://github.com/gpn-prototypes/vega-ui/packages).

_Внимание!_ На данный момент пакеты публикуются только Github-реджистри. В npm-реджистри не публикуются. Это значит, что через `npm` нельзя их установить, не указав откуда их нужно скачивать. Подробнее читай ниже.

## Как lerna определяет, до какой версии должен быть поднят ваш пакет?

Lerna смотрит на изменения в git у всех пакетов и на именование коммитов, в которых менялись пакеты.
Именование коммитов проверяется на основе спецификации [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/).

Примеры:

### Вы сделали фикс в пакет, от которого не зависят другие пакеты

- Есть компонент `@gpn-prototypes/vega-user` версии `v0.1.1`
- Есть пакет с пакетами `@gpn-prototypes/vega-ui` версии `v1.0.0` — содержит внутри пакет `vega-user`
- Вы сделали фикс внутри `packages/components/user`
- Создали коммит `fix(user): поправлен отступ`
- Создали PR с этими изменениями, его вмержили в `master`

После этого lerna обновит пакеты:

- `@gpn-prototypes/vega-user@0.1.1` → `0.1.2` - был коммит `fix` без breaking chage, значит повышаем `patch`
- `@gpn-prototypes/vega-ui@1.0.0` → `1.0.1` – т.к. внутри пакета с пакетами есть пакет `vega-user` и у него было патч-изменение

### Вы добавили фичу в пакет, от которого зависит другой пакет

- Есть компонент `@gpn-prototypes/vega-button` версии `v0.1.1`
- Есть компонент `@gpn-prototypes/vega-modal` версии `v0.2.0`, он использует пакет `vega-button`
- Есть пакет с пакетами `@gpn-prototypes/vega-ui` версии `v1.0.0` - содержит внутри пакеты `vega-button` и `vega-modal`
- Вы добавили новую фичу внутрь `packages/components/button`
- Создали коммит `feat(button): добавлены новые размеры`
- Создали PR с этими изменениями, его вмержили в `master`

После этого lerna обновит пакеты:

- `@gpn-prototypes/vega-button@0.1.1` → `0.2.0` – был коммит `feat` без breaking change, значит повышаем `minor`
- `@gpn-prototypes/vega-ui@1.0.0` → `1.1.0` – т.к. внутри пакета с пакетами есть пакет `vega-button`, и у него было минорное изменение
- `@gpn-prototypes/vega-modal@0.2.0` → `0.2.1` - модалка использует внутри себя `vega-button`, у которой было минорное изменение. Но сама модалка изменяет только патч! Потому что нам не пришлось никак менять модалку после изменения в пакете `vega-button`. Значит у модалки не поменялось API и не изменилось ожидаемое внутреннее поведение

Если бы vega-button поменялась бы настолько, что пришлось бы править использование кнопки внутри модалки, то мы бы сделали отдельный коммит с изменением vega-modal и выбрали бы тип коммита `feat`/`fix`.

## Как установить опубликованный пакет в ваш проект

Чтобы при установке зависимостей `npm` понимал, откуда ему нужно скачивать пакеты со скоупом `@gpn-prototypes`, нужно явно ему указать адрес реджистри.

Один из способов: создать в вашем проекте файл `.npmrc` с адресом реджистри:

```bash
@gpn-prototypes:registry=https://npm.pkg.github.com
registry=https://registry.npmjs.org/
```

После этого можно устанавливать зависимости как обычно:

- `yarn add @ttteam-org/vega-ui` – установить все компоненты
- `yarn add @ttteam-org/vega-modal` — только один компонент
- `yarn add @ttteam-org/vega-hooks` — все хуки

Использование:

```typescript
import { Avatar, Button, Dropdown } from @ttteam-org/vega-ui;
import { useClickOutside } from @ttteam-org/vega-hooks;
import { Modal } from @ttteam-org/vega-modal;
```
